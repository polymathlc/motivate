<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CER Quest ‚Äî Question Builder Tracker</title>

  <!-- Firebase Compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics-compat.js"></script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700;900&family=Rajdhani:wght@400;500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet" />

  <style>
    /* ============================================================
       CSS VARIABLES & BASE RESET
       ============================================================ */
    :root {
      --bg-deep:        #040810;
      --bg-panel:       #090f1e;
      --bg-card:        #0d1528;
      --bg-card-hover:  #111d38;
      --border:         #1e2f55;
      --border-bright:  #2a4080;

      --gold:           #f5c842;
      --gold-dim:       #c49a1e;
      --gold-glow:      rgba(245,200,66,0.25);

      --cyan:           #00e5ff;
      --cyan-dim:       #0099bb;
      --cyan-glow:      rgba(0,229,255,0.20);

      --violet:         #a855f7;
      --violet-glow:    rgba(168,85,247,0.25);

      --green:          #22c55e;
      --green-glow:     rgba(34,197,94,0.25);

      --red:            #ef4444;
      --orange:         #f97316;

      --text-primary:   #e8edf8;
      --text-secondary: #7e93b8;
      --text-muted:     #3d5070;

      --xp-bar-bg:      #111d38;
      --radius-lg:      16px;
      --radius-md:      10px;
      --radius-sm:      6px;
      --transition:     all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html { font-size: 16px; scroll-behavior: smooth; }

    body {
      background: var(--bg-deep);
      color: var(--text-primary);
      font-family: 'Rajdhani', sans-serif;
      font-weight: 500;
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
    }

    /* Starfield background */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background:
        radial-gradient(ellipse 80% 60% at 50% 0%, rgba(0,80,180,0.12) 0%, transparent 70%),
        radial-gradient(ellipse 50% 30% at 20% 80%, rgba(168,85,247,0.07) 0%, transparent 60%),
        radial-gradient(ellipse 60% 40% at 80% 60%, rgba(0,229,255,0.05) 0%, transparent 60%);
      pointer-events: none;
      z-index: 0;
    }

    /* Animated grid lines */
    body::after {
      content: '';
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(rgba(30,47,85,0.3) 1px, transparent 1px),
        linear-gradient(90deg, rgba(30,47,85,0.3) 1px, transparent 1px);
      background-size: 60px 60px;
      mask-image: radial-gradient(ellipse 90% 90% at 50% 50%, black 40%, transparent 100%);
      pointer-events: none;
      z-index: 0;
    }

    /* ============================================================
       LAYOUT
       ============================================================ */
    #app { position: relative; z-index: 1; }

    /* ============================================================
       LOGIN SCREEN
       ============================================================ */
    #login-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 40px 20px;
      text-align: center;
    }

    .login-orb {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: radial-gradient(circle at 35% 35%, var(--cyan), #0044aa 60%, #020c24);
      box-shadow:
        0 0 60px rgba(0,229,255,0.4),
        0 0 120px rgba(0,120,220,0.2),
        inset 0 0 40px rgba(0,229,255,0.3);
      margin-bottom: 32px;
      animation: orbPulse 3s ease-in-out infinite;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
    }

    @keyframes orbPulse {
      0%, 100% { transform: scale(1);   box-shadow: 0 0 60px rgba(0,229,255,0.4), 0 0 120px rgba(0,120,220,0.2); }
      50%       { transform: scale(1.05); box-shadow: 0 0 80px rgba(0,229,255,0.6), 0 0 160px rgba(0,120,220,0.3); }
    }

    .login-title {
      font-family: 'Cinzel Decorative', serif;
      font-size: clamp(24px, 5vw, 40px);
      font-weight: 900;
      color: var(--gold);
      text-shadow: 0 0 30px var(--gold-glow), 0 0 60px rgba(245,200,66,0.1);
      letter-spacing: 0.05em;
      line-height: 1.2;
      margin-bottom: 12px;
    }

    .login-subtitle {
      font-size: 18px;
      color: var(--text-secondary);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      margin-bottom: 48px;
      max-width: 420px;
    }

    .login-subtitle span { color: var(--cyan); }

    .google-signin-btn {
      display: flex;
      align-items: center;
      gap: 14px;
      background: var(--bg-card);
      border: 1px solid var(--border-bright);
      border-radius: var(--radius-lg);
      padding: 16px 32px;
      cursor: pointer;
      font-family: 'Rajdhani', sans-serif;
      font-weight: 700;
      font-size: 18px;
      letter-spacing: 0.06em;
      color: var(--text-primary);
      text-transform: uppercase;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .google-signin-btn::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, transparent 40%, rgba(0,229,255,0.08));
      opacity: 0;
      transition: var(--transition);
    }

    .google-signin-btn:hover {
      border-color: var(--cyan);
      box-shadow: 0 0 30px var(--cyan-glow), 0 8px 30px rgba(0,0,0,0.4);
      transform: translateY(-2px);
    }

    .google-signin-btn:hover::before { opacity: 1; }

    .google-icon {
      width: 28px;
      height: 28px;
      flex-shrink: 0;
    }

    .login-tagline {
      margin-top: 28px;
      font-size: 14px;
      color: var(--text-muted);
      letter-spacing: 0.05em;
    }

    /* ============================================================
       MAIN APP WRAPPER
       ============================================================ */
    #main-app {
      display: none;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px 16px 60px;
    }

    #main-app.visible { display: block; }

    /* ============================================================
       TOP HEADER
       ============================================================ */
    .top-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 0 24px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 28px;
      flex-wrap: wrap;
      gap: 16px;
    }

    .header-brand {
      font-family: 'Cinzel Decorative', serif;
      font-size: 20px;
      font-weight: 700;
      color: var(--gold);
      text-shadow: 0 0 20px var(--gold-glow);
      letter-spacing: 0.04em;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .user-chip {
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 50px;
      padding: 6px 16px 6px 6px;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 2px solid var(--gold-dim);
      object-fit: cover;
    }

    .user-avatar-fallback {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 2px solid var(--gold-dim);
      background: linear-gradient(135deg, #1a3a70, #0d1f45);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
      color: var(--gold);
    }

    .sign-out-btn {
      background: transparent;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 6px 14px;
      color: var(--text-muted);
      font-family: 'Rajdhani', sans-serif;
      font-size: 13px;
      cursor: pointer;
      transition: var(--transition);
      letter-spacing: 0.04em;
    }

    .sign-out-btn:hover {
      border-color: var(--red);
      color: var(--red);
    }

    /* ============================================================
       HERO / LEVEL SECTION
       ============================================================ */
    .hero-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 28px;
    }

    @media (max-width: 768px) {
      .hero-section { grid-template-columns: 1fr; }
    }

    /* Level Card */
    .level-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 28px 28px 24px;
      position: relative;
      overflow: hidden;
    }

    .level-card::before {
      content: '';
      position: absolute;
      top: -40px;
      right: -40px;
      width: 160px;
      height: 160px;
      background: radial-gradient(circle, rgba(245,200,66,0.12) 0%, transparent 70%);
      pointer-events: none;
    }

    .level-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(135deg, rgba(245,200,66,0.15), rgba(245,200,66,0.05));
      border: 1px solid rgba(245,200,66,0.3);
      border-radius: 50px;
      padding: 4px 14px;
      font-size: 12px;
      font-weight: 700;
      color: var(--gold);
      letter-spacing: 0.1em;
      text-transform: uppercase;
      margin-bottom: 12px;
    }

    .level-number {
      font-family: 'Cinzel Decorative', serif;
      font-size: 56px;
      font-weight: 900;
      color: var(--gold);
      text-shadow: 0 0 30px var(--gold-glow);
      line-height: 1;
      margin-bottom: 6px;
    }

    .level-title-text {
      font-size: 22px;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: 0.04em;
      margin-bottom: 20px;
    }

    .xp-track {
      margin-top: 4px;
    }

    .xp-label-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      color: var(--text-secondary);
      letter-spacing: 0.04em;
      margin-bottom: 8px;
    }

    .xp-label-row strong {
      color: var(--gold);
      font-family: 'Share Tech Mono', monospace;
    }

    .xp-bar-outer {
      height: 12px;
      background: var(--xp-bar-bg);
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid var(--border);
      position: relative;
    }

    .xp-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #c49a1e, #f5c842, #ffe066);
      border-radius: 6px;
      transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 0 12px rgba(245,200,66,0.5);
      position: relative;
    }

    .xp-bar-fill::after {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 50%;
      background: rgba(255,255,255,0.15);
      border-radius: 6px;
    }

    /* Streak Card */
    .streak-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 28px;
      position: relative;
      overflow: hidden;
    }

    .streak-card::before {
      content: '';
      position: absolute;
      bottom: -30px;
      left: -30px;
      width: 140px;
      height: 140px;
      background: radial-gradient(circle, rgba(249,115,22,0.12) 0%, transparent 70%);
      pointer-events: none;
    }

    .streak-header {
      font-size: 13px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--text-muted);
      font-weight: 600;
      margin-bottom: 14px;
    }

    .streak-number {
      font-family: 'Cinzel Decorative', serif;
      font-size: 64px;
      font-weight: 900;
      color: var(--orange);
      text-shadow: 0 0 30px rgba(249,115,22,0.4);
      line-height: 1;
    }

    .streak-label {
      font-size: 16px;
      color: var(--text-secondary);
      letter-spacing: 0.05em;
      margin-top: 4px;
      margin-bottom: 24px;
    }

    .streak-days {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .streak-day-dot {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      background: var(--bg-deep);
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 600;
      color: var(--text-muted);
      letter-spacing: 0;
      transition: var(--transition);
    }

    .streak-day-dot.active {
      background: linear-gradient(135deg, rgba(249,115,22,0.3), rgba(249,115,22,0.1));
      border-color: var(--orange);
      color: var(--orange);
      box-shadow: 0 0 10px rgba(249,115,22,0.3);
    }

    .streak-day-dot.today {
      background: linear-gradient(135deg, rgba(249,115,22,0.5), rgba(249,115,22,0.2));
      border-color: var(--orange);
      color: #fff;
      box-shadow: 0 0 16px rgba(249,115,22,0.5);
      transform: scale(1.1);
    }

    /* ============================================================
       ADD QUESTION BUTTON ‚Äî THE MAIN CTA
       ============================================================ */
    .action-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 32px;
      position: relative;
    }

    .add-question-btn {
      width: 180px;
      height: 180px;
      border-radius: 50%;
      border: none;
      background: radial-gradient(circle at 35% 35%, #1a6fff, #0033aa 55%, #001266);
      box-shadow:
        0 0 0 3px rgba(0,229,255,0.3),
        0 0 40px rgba(0,100,255,0.4),
        0 0 80px rgba(0,60,200,0.2),
        0 8px 32px rgba(0,0,0,0.6);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: relative;
      overflow: hidden;
    }

    .add-question-btn::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, transparent 50%);
    }

    .add-question-btn:hover {
      transform: scale(1.08);
      box-shadow:
        0 0 0 4px rgba(0,229,255,0.5),
        0 0 60px rgba(0,100,255,0.6),
        0 0 100px rgba(0,60,200,0.3),
        0 12px 40px rgba(0,0,0,0.6);
    }

    .add-question-btn:active {
      transform: scale(0.95);
    }

    .add-question-btn.animate {
      animation: btnPop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes btnPop {
      0%   { transform: scale(1); }
      40%  { transform: scale(0.9); }
      70%  { transform: scale(1.15); }
      100% { transform: scale(1); }
    }

    .btn-plus {
      font-size: 52px;
      font-weight: 300;
      color: #fff;
      line-height: 1;
      text-shadow: 0 0 20px rgba(0,229,255,0.8);
      position: relative;
      z-index: 1;
    }

    .btn-label {
      font-family: 'Rajdhani', sans-serif;
      font-weight: 700;
      font-size: 12px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.7);
      position: relative;
      z-index: 1;
    }

    /* Ripple ring animation on click */
    .ripple-container {
      position: absolute;
      pointer-events: none;
      width: 180px;
      height: 180px;
    }

    .ripple-ring {
      position: absolute;
      inset: 0;
      border-radius: 50%;
      border: 2px solid rgba(0,229,255,0.6);
      animation: rippleOut 0.8s ease-out forwards;
    }

    @keyframes rippleOut {
      0%   { transform: scale(1); opacity: 0.8; }
      100% { transform: scale(2.5); opacity: 0; }
    }

    .action-hint {
      margin-top: 16px;
      font-size: 13px;
      color: var(--text-muted);
      letter-spacing: 0.06em;
      text-align: center;
    }

    /* Today's count display */
    .today-count-display {
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 50px;
      padding: 8px 24px;
      margin-top: 16px;
      font-size: 15px;
      color: var(--text-secondary);
    }

    .today-count-display .count-num {
      font-family: 'Share Tech Mono', monospace;
      font-size: 22px;
      color: var(--cyan);
      text-shadow: 0 0 10px var(--cyan-glow);
    }

    /* ============================================================
       XP FLOATING POPUPS
       ============================================================ */
    .xp-popup {
      position: fixed;
      pointer-events: none;
      z-index: 9999;
      font-family: 'Cinzel Decorative', serif;
      font-size: 22px;
      font-weight: 700;
      color: var(--gold);
      text-shadow: 0 0 20px var(--gold-glow);
      animation: xpFloat 1.4s ease-out forwards;
    }

    @keyframes xpFloat {
      0%   { transform: translate(-50%, 0) scale(0.5);   opacity: 0; }
      20%  { transform: translate(-50%, -20px) scale(1.3); opacity: 1; }
      60%  { transform: translate(-50%, -60px) scale(1);   opacity: 1; }
      100% { transform: translate(-50%, -110px) scale(0.8); opacity: 0; }
    }

    /* Level Up Toast */
    .level-up-toast {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.5);
      background: var(--bg-card);
      border: 2px solid var(--gold);
      border-radius: var(--radius-lg);
      padding: 40px 56px;
      text-align: center;
      z-index: 10000;
      opacity: 0;
      pointer-events: none;
      box-shadow: 0 0 80px var(--gold-glow), 0 0 160px rgba(245,200,66,0.1);
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .level-up-toast.show {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
      pointer-events: auto;
    }

    .level-up-toast .toast-icon { font-size: 56px; margin-bottom: 12px; }

    .level-up-toast h2 {
      font-family: 'Cinzel Decorative', serif;
      color: var(--gold);
      font-size: 28px;
      text-shadow: 0 0 20px var(--gold-glow);
      margin-bottom: 8px;
    }

    .level-up-toast p {
      color: var(--text-secondary);
      font-size: 16px;
      letter-spacing: 0.05em;
    }

    .toast-close-btn {
      margin-top: 24px;
      background: linear-gradient(135deg, var(--gold-dim), var(--gold));
      color: #040810;
      border: none;
      border-radius: var(--radius-sm);
      padding: 10px 28px;
      font-family: 'Rajdhani', sans-serif;
      font-weight: 700;
      font-size: 15px;
      letter-spacing: 0.08em;
      cursor: pointer;
      transition: var(--transition);
    }

    .toast-close-btn:hover { transform: scale(1.05); }

    .toast-overlay {
      position: fixed;
      inset: 0;
      background: rgba(4,8,16,0.7);
      z-index: 9999;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }

    .toast-overlay.show { opacity: 1; pointer-events: auto; }

    /* ============================================================
       STATS TABS
       ============================================================ */
    .stats-section {
      margin-bottom: 28px;
    }

    .section-heading {
      font-family: 'Cinzel Decorative', serif;
      font-size: 15px;
      font-weight: 700;
      color: var(--text-secondary);
      letter-spacing: 0.12em;
      text-transform: uppercase;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-heading::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    .tabs-row {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 5px;
    }

    .tab-btn {
      flex: 1;
      background: transparent;
      border: none;
      border-radius: 7px;
      padding: 9px 8px;
      cursor: pointer;
      font-family: 'Rajdhani', sans-serif;
      font-weight: 700;
      font-size: 14px;
      letter-spacing: 0.07em;
      text-transform: uppercase;
      color: var(--text-muted);
      transition: var(--transition);
    }

    .tab-btn:hover { color: var(--text-secondary); }

    .tab-btn.active {
      background: var(--bg-card-hover);
      color: var(--cyan);
      box-shadow: 0 0 12px var(--cyan-glow);
    }

    /* Stats Cards Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 14px;
    }

    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 18px 16px;
      text-align: center;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .stat-card:hover {
      border-color: var(--border-bright);
      background: var(--bg-card-hover);
      transform: translateY(-2px);
    }

    .stat-card-icon {
      font-size: 28px;
      margin-bottom: 8px;
      display: block;
    }

    .stat-card-value {
      font-family: 'Share Tech Mono', monospace;
      font-size: 32px;
      font-weight: 400;
      color: var(--cyan);
      text-shadow: 0 0 15px var(--cyan-glow);
      line-height: 1;
      margin-bottom: 4px;
    }

    .stat-card-label {
      font-size: 12px;
      color: var(--text-muted);
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    /* Chart area */
    .chart-area {
      margin-top: 20px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 24px;
    }

    .chart-title {
      font-size: 14px;
      color: var(--text-secondary);
      letter-spacing: 0.06em;
      text-transform: uppercase;
      font-weight: 600;
      margin-bottom: 20px;
    }

    .bar-chart {
      display: flex;
      align-items: flex-end;
      gap: 6px;
      height: 120px;
    }

    .bar-col {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      height: 100%;
    }

    .bar-fill-container {
      flex: 1;
      width: 100%;
      display: flex;
      align-items: flex-end;
      justify-content: center;
    }

    .bar-fill {
      width: 80%;
      background: linear-gradient(180deg, var(--cyan), var(--cyan-dim));
      border-radius: 4px 4px 0 0;
      min-height: 4px;
      transition: height 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 0 8px var(--cyan-glow);
      position: relative;
    }

    .bar-fill.today-bar {
      background: linear-gradient(180deg, var(--gold), var(--gold-dim));
      box-shadow: 0 0 12px var(--gold-glow);
    }

    .bar-fill-num {
      position: absolute;
      top: -22px;
      left: 50%;
      transform: translateX(-50%);
      font-family: 'Share Tech Mono', monospace;
      font-size: 11px;
      color: var(--text-secondary);
      white-space: nowrap;
    }

    .bar-label {
      font-size: 11px;
      color: var(--text-muted);
      letter-spacing: 0.04em;
      text-align: center;
    }

    /* ============================================================
       ACHIEVEMENTS SECTION
       ============================================================ */
    .achievements-section {
      margin-bottom: 28px;
    }

    .achievements-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
    }

    .achievement-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 14px;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .achievement-card.unlocked {
      border-color: rgba(245,200,66,0.3);
    }

    .achievement-card.unlocked::after {
      content: '';
      position: absolute;
      top: 0; left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--gold), transparent);
    }

    .achievement-card:hover {
      background: var(--bg-card-hover);
      transform: translateY(-2px);
    }

    .achievement-icon {
      font-size: 32px;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-sm);
      background: var(--bg-deep);
      border: 1px solid var(--border);
      flex-shrink: 0;
      filter: grayscale(1) opacity(0.4);
      transition: var(--transition);
    }

    .achievement-card.unlocked .achievement-icon {
      filter: none;
      background: linear-gradient(135deg, rgba(245,200,66,0.15), rgba(245,200,66,0.05));
      border-color: rgba(245,200,66,0.3);
      box-shadow: 0 0 12px var(--gold-glow);
    }

    .achievement-info { flex: 1; min-width: 0; }

    .achievement-name {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-secondary);
      letter-spacing: 0.03em;
      margin-bottom: 3px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .achievement-card.unlocked .achievement-name { color: var(--text-primary); }

    .achievement-desc {
      font-size: 11px;
      color: var(--text-muted);
      letter-spacing: 0.03em;
      line-height: 1.4;
    }

    .achievement-status {
      font-size: 11px;
      font-family: 'Share Tech Mono', monospace;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .achievement-card.unlocked .achievement-status { color: var(--gold); }

    /* ============================================================
       MILESTONE PROGRESS
       ============================================================ */
    .milestone-section {
      margin-bottom: 28px;
    }

    .milestone-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .milestone-item {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 14px 18px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .milestone-item.completed {
      border-color: rgba(34,197,94,0.3);
    }

    .milestone-item.completed .milestone-icon {
      color: var(--green);
    }

    .milestone-icon {
      font-size: 20px;
      color: var(--text-muted);
      width: 28px;
      text-align: center;
      flex-shrink: 0;
    }

    .milestone-content { flex: 1; }

    .milestone-title {
      font-size: 15px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .milestone-progress-bar-outer {
      height: 6px;
      background: var(--bg-deep);
      border-radius: 3px;
      overflow: hidden;
    }

    .milestone-progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--cyan-dim), var(--cyan));
      border-radius: 3px;
      transition: width 0.6s ease;
      box-shadow: 0 0 6px var(--cyan-glow);
    }

    .milestone-item.completed .milestone-progress-bar-fill {
      background: linear-gradient(90deg, #16a34a, var(--green));
    }

    .milestone-fraction {
      font-family: 'Share Tech Mono', monospace;
      font-size: 13px;
      color: var(--text-secondary);
      white-space: nowrap;
      min-width: 70px;
      text-align: right;
    }

    .milestone-item.completed .milestone-fraction { color: var(--green); }

    /* ============================================================
       HISTORY / ACTIVITY LOG
       ============================================================ */
    .history-section {
      margin-bottom: 28px;
    }

    .activity-log {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      max-height: 320px;
      overflow-y: auto;
    }

    .activity-log::-webkit-scrollbar { width: 4px; }
    .activity-log::-webkit-scrollbar-track { background: var(--bg-card); }
    .activity-log::-webkit-scrollbar-thumb { background: var(--border-bright); border-radius: 2px; }

    .log-entry {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 12px 18px;
      border-bottom: 1px solid var(--border);
      transition: var(--transition);
      animation: logSlide 0.4s ease-out;
    }

    .log-entry:last-child { border-bottom: none; }
    .log-entry:hover { background: var(--bg-card-hover); }

    @keyframes logSlide {
      from { transform: translateX(-10px); opacity: 0; }
      to   { transform: translateX(0);     opacity: 1; }
    }

    .log-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--cyan);
      box-shadow: 0 0 8px var(--cyan-glow);
      flex-shrink: 0;
    }

    .log-text {
      flex: 1;
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.4;
    }

    .log-text strong { color: var(--text-primary); }
    .log-text .xp-highlight { color: var(--gold); font-family: 'Share Tech Mono', monospace; }

    .log-time {
      font-family: 'Share Tech Mono', monospace;
      font-size: 11px;
      color: var(--text-muted);
      white-space: nowrap;
    }

    .log-empty {
      padding: 40px;
      text-align: center;
      color: var(--text-muted);
      font-size: 14px;
      letter-spacing: 0.06em;
    }

    /* ============================================================
       TASKS + RPG
       ============================================================ */
    .task-section,
    .rpg-section,
    .minigame-section {
      margin-bottom: 28px;
    }

    .task-create-card,
    .todo-list,
    .rpg-card,
    .battle-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 18px;
    }

    .task-create-row {
      display: grid;
      grid-template-columns: 1fr 120px 110px;
      gap: 10px;
      margin-top: 12px;
    }

    .task-input,
    .task-select {
      width: 100%;
      background: var(--bg-deep);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-family: 'Rajdhani', sans-serif;
      font-size: 15px;
      padding: 10px 12px;
    }

    .task-input:focus,
    .task-select:focus {
      outline: none;
      border-color: var(--cyan);
      box-shadow: 0 0 0 2px var(--cyan-glow);
    }

    .quest-btn {
      border: 1px solid var(--border-bright);
      border-radius: var(--radius-sm);
      background: linear-gradient(135deg, #1a3a70, #0d1f45);
      color: var(--text-primary);
      font-family: 'Rajdhani', sans-serif;
      font-size: 14px;
      font-weight: 700;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      padding: 10px 14px;
      cursor: pointer;
      transition: var(--transition);
    }

    .quest-btn:hover {
      border-color: var(--cyan);
      box-shadow: 0 0 16px var(--cyan-glow);
    }

    .quest-btn.warn:hover {
      border-color: var(--gold);
      box-shadow: 0 0 16px var(--gold-glow);
    }

    .todo-list {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 12px;
    }

    .todo-row {
      background: var(--bg-deep);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 10px 12px;
      display: grid;
      grid-template-columns: 1fr auto auto;
      gap: 10px;
      align-items: center;
    }

    .todo-title {
      color: var(--text-primary);
      font-size: 15px;
      line-height: 1.3;
    }

    .todo-title.done {
      text-decoration: line-through;
      color: var(--text-muted);
    }

    .tag {
      border-radius: 50px;
      padding: 3px 10px;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      border: 1px solid var(--border);
      color: var(--text-secondary);
    }

    .tag.high {
      border-color: rgba(245,200,66,0.4);
      color: var(--gold);
      background: rgba(245,200,66,0.1);
    }

    .rpg-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .slot-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-top: 10px;
    }

    .slot-card {
      background: var(--bg-deep);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 8px;
      min-height: 72px;
    }

    .slot-name {
      color: var(--text-muted);
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 0.08em;
      margin-bottom: 4px;
    }

    .slot-item {
      color: var(--text-primary);
      font-size: 13px;
    }

    .slot-empty {
      color: var(--text-muted);
      font-size: 12px;
    }

    .inventory-list {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 7px;
      max-height: 220px;
      overflow-y: auto;
    }

    .inventory-row {
      background: var(--bg-deep);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 8px 10px;
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 10px;
    }

    .skills-row {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .skill-pill {
      border: 1px solid rgba(168,85,247,0.4);
      background: rgba(168,85,247,0.12);
      color: #d7b4ff;
      border-radius: 50px;
      padding: 6px 10px;
      font-size: 12px;
      letter-spacing: 0.04em;
    }

    .battle-stats {
      margin-top: 10px;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }

    .battle-stat {
      background: var(--bg-deep);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      text-align: center;
      padding: 8px 6px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .battle-controls {
      margin-top: 12px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .battle-log {
      margin-top: 12px;
      background: var(--bg-deep);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 10px;
      min-height: 42px;
      color: var(--text-secondary);
      font-size: 13px;
    }

    @media (max-width: 900px) {
      .task-create-row { grid-template-columns: 1fr; }
      .rpg-grid { grid-template-columns: 1fr; }
      .battle-stats { grid-template-columns: repeat(2, 1fr); }
    }

    /* ============================================================
       LOADING STATE
       ============================================================ */
    #loading-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      gap: 20px;
    }

    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 3px solid var(--border);
      border-top-color: var(--cyan);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .loading-text {
      font-size: 14px;
      color: var(--text-muted);
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    /* ============================================================
       RESPONSIVE TWEAKS
       ============================================================ */
    @media (max-width: 600px) {
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .achievements-grid { grid-template-columns: 1fr; }
      .tabs-row { gap: 4px; }
      .tab-btn { font-size: 12px; padding: 8px 4px; }
    }

    /* ============================================================
       SCROLL CUSTOM
       ============================================================ */
    html::-webkit-scrollbar { width: 6px; }
    html::-webkit-scrollbar-track { background: var(--bg-deep); }
    html::-webkit-scrollbar-thumb { background: var(--border-bright); border-radius: 3px; }

    /* Confetti canvas */
    #confetti-canvas {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 9998;
    }
  </style>
</head>
<body>

<canvas id="confetti-canvas"></canvas>

<!-- Loading -->
<div id="loading-screen">
  <div class="loading-spinner"></div>
  <div class="loading-text">Initialising Quest System‚Ä¶</div>
</div>

<!-- Login Screen -->
<div id="login-screen" style="display:none;">
  <div class="login-orb">üìú</div>
  <div class="login-title">CER Quest</div>
  <div class="login-subtitle">
    Track every question you build.<br/>
    Earn XP. Level up. Build the <span>ultimate question bank</span>.
  </div>
  <button class="google-signin-btn" onclick="signInWithGoogle()">
    <svg class="google-icon" viewBox="0 0 48 48">
      <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
      <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
      <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
      <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.31-8.16 2.31-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
      <path fill="none" d="M0 0h48v48H0z"/>
    </svg>
    Sign in with Google
  </button>
  <div class="login-tagline">Your progress is saved in the cloud ‚Äî across all devices.</div>
</div>

<!-- Overlay for level-up toast -->
<div class="toast-overlay" id="toast-overlay" onclick="closeLevelUpToast()"></div>

<!-- Level Up Toast -->
<div class="level-up-toast" id="level-up-toast">
  <div class="toast-icon">üèÜ</div>
  <h2 id="toast-level-text">LEVEL UP!</h2>
  <p id="toast-title-text">You are now a Question Apprentice</p>
  <button class="toast-close-btn" onclick="closeLevelUpToast()">CONTINUE QUEST</button>
</div>

<!-- Main App -->
<div id="main-app">
  <div class="top-header">
    <div class="header-brand">‚öî CER Quest</div>
    <div class="header-right">
      <div class="user-chip">
        <div class="user-avatar-fallback" id="user-avatar-el">ZK</div>
        <span id="user-name-el">Zhi Kai</span>
      </div>
      <button class="sign-out-btn" onclick="signOut()">Sign Out</button>
    </div>
  </div>

  <!-- Hero: Level + Streak -->
  <div class="hero-section">
    <div class="level-card">
      <div class="level-badge">‚öî Class: <span id="rank-title">Novice Scholar</span></div>
      <div class="level-number" id="level-number">1</div>
      <div class="level-title-text">Scholar Level</div>
      <div class="xp-track">
        <div class="xp-label-row">
          <span>EXPERIENCE</span>
          <strong id="xp-display">0 / 100 XP</strong>
        </div>
        <div class="xp-bar-outer">
          <div class="xp-bar-fill" id="xp-bar" style="width:0%"></div>
        </div>
      </div>
    </div>

    <div class="streak-card">
      <div class="streak-header">üî• Current Daily Streak</div>
      <div class="streak-number" id="streak-number">0</div>
      <div class="streak-label">Days Active</div>
      <div class="streak-days" id="streak-days-row">
        <!-- Filled by JS -->
      </div>
    </div>
  </div>

  <!-- ADD QUESTION BUTTON -->
  <div class="action-section">
    <div class="ripple-container" id="ripple-container"></div>
    <button class="add-question-btn" id="add-btn" onclick="addQuestion()">
      <div class="btn-plus">+</div>
      <div class="btn-label">Add Question</div>
    </button>
    <div class="today-count-display">
      <span>Today:</span>
      <span class="count-num" id="today-count">0</span>
      <span>questions added</span>
    </div>
    <div class="action-hint">Each question earns +<span id="xp-per-q">10</span> XP ¬∑ Keep building!</div>
  </div>

  <!-- STATS TABS -->
  <div class="stats-section">
    <div class="section-heading">üìä Analytics</div>
    <div class="tabs-row">
      <button class="tab-btn active" onclick="switchTab('daily')">Daily</button>
      <button class="tab-btn" onclick="switchTab('weekly')">Weekly</button>
      <button class="tab-btn" onclick="switchTab('monthly')">Monthly</button>
      <button class="tab-btn" onclick="switchTab('yearly')">Yearly</button>
    </div>
    <div class="stats-grid" id="stats-grid">
      <!-- Filled by JS -->
    </div>
    <div class="chart-area" id="chart-area">
      <div class="chart-title" id="chart-title">Last 7 Days</div>
      <div class="bar-chart" id="bar-chart">
        <!-- Filled by JS -->
      </div>
    </div>
  </div>

  <!-- MILESTONES -->
  <div class="milestone-section">
    <div class="section-heading">üéØ Milestones</div>
    <div class="milestone-list" id="milestone-list">
      <!-- Filled by JS -->
    </div>
  </div>

  <!-- ACHIEVEMENTS -->
  <div class="achievements-section">
    <div class="section-heading">üèÖ Achievements</div>
    <div class="achievements-grid" id="achievements-grid">
      <!-- Filled by JS -->
    </div>
  </div>

  <!-- TASKS -->
  <div class="task-section">
    <div class="section-heading">üßæ Todo Quest Board</div>
    <div class="task-create-card">
      <div>Create a task with importance from 5 to 10. Completing tasks grants XP, achievements, and loot.</div>
      <div class="task-create-row">
        <input id="task-title-input" class="task-input" type="text" maxlength="120" placeholder="Add a task..." />
        <select id="task-importance-input" class="task-select">
          <option value="5">Importance 5</option>
          <option value="6">Importance 6</option>
          <option value="7">Importance 7</option>
          <option value="8">Importance 8</option>
          <option value="9">Importance 9</option>
          <option value="10" selected>Importance 10</option>
        </select>
        <button class="quest-btn" onclick="addTask()">Add Task</button>
      </div>
    </div>
    <div class="todo-list" id="todo-list"></div>
  </div>

  <!-- RPG -->
  <div class="rpg-section">
    <div class="section-heading">üõ° Character, Slots, Skills</div>
    <div class="rpg-grid">
      <div class="rpg-card">
        <div><strong>Equipment Slots</strong> (Diablo style)</div>
        <div class="slot-grid" id="slot-grid"></div>
      </div>
      <div class="rpg-card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
          <strong>Randomized Skills</strong>
          <button class="quest-btn warn" onclick="rerollSkills()">Reroll</button>
        </div>
        <div class="skills-row" id="skills-row"></div>
        <div style="margin-top:12px;"><strong>Inventory</strong></div>
        <div class="inventory-list" id="inventory-list"></div>
      </div>
    </div>
  </div>

  <!-- MINI GAME -->
  <div class="minigame-section">
    <div class="section-heading">‚öî Mini Game Arena</div>
    <div class="battle-card">
      <div>Fight a random foe using your skills and gear. Victories grant XP and items.</div>
      <div class="battle-stats" id="battle-stats"></div>
      <div class="battle-controls">
        <button class="quest-btn" onclick="startBattle()">Start Battle</button>
        <button class="quest-btn" onclick="battleAttack()">Attack</button>
        <button class="quest-btn warn" onclick="battleSkill()">Use Skill</button>
      </div>
      <div class="battle-log" id="battle-log">No battle yet. Start one to enter the arena.</div>
    </div>
  </div>

  <!-- HISTORY -->
  <div class="history-section">
    <div class="section-heading">üìã Activity Log</div>
    <div class="activity-log" id="activity-log">
      <div class="log-empty">No activity yet ‚Äî press + to begin your quest!</div>
    </div>
  </div>
</div>

<!-- ================================================================
     SCRIPTS
     ================================================================ -->
<script>
/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   FIREBASE CONFIG & INIT
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const firebaseConfig = {
  apiKey:            "AIzaSyAUSI3Uh28IeqASEp0JhH4QPaVt-O3meBo",
  authDomain:        "mathgen--app.firebaseapp.com",
  projectId:         "mathgen--app",
  storageBucket:     "mathgen--app.firebasestorage.app",
  messagingSenderId: "165654161198",
  appId:             "1:165654161198:web:16c8bd60eb3a2aa7edbcbf",
  measurementId:     "G-0MWZFG211D"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   LEVEL / XP CONFIGURATION
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const LEVEL_CONFIG = [
  { level: 1,  title: "Novice Scholar",      xpRequired: 0,    xpNeeded: 100  },
  { level: 2,  title: "Question Builder",    xpRequired: 100,  xpNeeded: 200  },
  { level: 3,  title: "CER Apprentice",      xpRequired: 300,  xpNeeded: 350  },
  { level: 4,  title: "Evidence Seeker",     xpRequired: 650,  xpNeeded: 500  },
  { level: 5,  title: "Reasoning Mage",      xpRequired: 1150, xpNeeded: 700  },
  { level: 6,  title: "Claim Architect",     xpRequired: 1850, xpNeeded: 1000 },
  { level: 7,  title: "Grand Inquisitor",    xpRequired: 2850, xpNeeded: 1400 },
  { level: 8,  title: "Master of Evidence",  xpRequired: 4250, xpNeeded: 1800 },
  { level: 9,  title: "Lore Keeper",         xpRequired: 6050, xpNeeded: 2500 },
  { level: 10, title: "Polymath Legend",     xpRequired: 8550, xpNeeded: 9999 },
];

const XP_BASE = 10; // base XP per question

const TASK_IMPORTANCE_MIN = 5;
const TASK_IMPORTANCE_MAX = 10;

const SKILL_POOL = [
  { id: 'arc_bolt',       name: 'Arc Bolt',       power: 1.45 },
  { id: 'shadow_nova',    name: 'Shadow Nova',    power: 1.7  },
  { id: 'frost_spike',    name: 'Frost Spike',    power: 1.55 },
  { id: 'ember_wave',     name: 'Ember Wave',     power: 1.6  },
  { id: 'storm_lance',    name: 'Storm Lance',    power: 1.8  },
  { id: 'astral_cleave',  name: 'Astral Cleave',  power: 1.65 },
];

const ITEM_TEMPLATES = [
  { slot: 'helm',   names: ['Iron Visor', 'Rune Helm', 'Lion Crest'],   atk: [0, 2], def: [2, 5] },
  { slot: 'chest',  names: ['Scale Armor', 'Night Plate', 'Aegis Mail'],atk: [0, 1], def: [4, 8] },
  { slot: 'gloves', names: ['Grip Gloves', 'Swift Mitts', 'Fang Grips'],atk: [1, 3], def: [1, 3] },
  { slot: 'pants',  names: ['Guard Greaves', 'Dusk Leggings'],           atk: [0, 1], def: [3, 6] },
  { slot: 'boots',  names: ['Trail Boots', 'Windstep Boots'],            atk: [0, 1], def: [2, 4] },
  { slot: 'weapon', names: ['Bone Blade', 'Storm Staff', 'Moon Axe'],    atk: [4, 8], def: [0, 2] },
  { slot: 'offhand',names: ['Ward Totem', 'Mirror Shield'],              atk: [1, 3], def: [2, 5] },
  { slot: 'ring1',  names: ['Ring of Sparks', 'Band of Focus'],          atk: [1, 3], def: [1, 2] },
  { slot: 'ring2',  names: ['Ring of Echoes', 'Band of Will'],           atk: [1, 3], def: [1, 2] },
  { slot: 'amulet', names: ['Sun Amulet', 'Void Pendant'],               atk: [1, 4], def: [1, 3] },
];

const EQUIPMENT_SLOTS = ['helm', 'chest', 'gloves', 'pants', 'boots', 'weapon', 'offhand', 'ring1', 'ring2', 'amulet'];

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   ACHIEVEMENT DEFINITIONS
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const ACHIEVEMENTS_DEF = [
  { id: "first_question",    icon: "üìù", name: "First Question",    desc: "Add your very first question",             threshold: 1,    stat: "total"     },
  { id: "ten_questions",     icon: "üîü", name: "Ten Questions",     desc: "Reach 10 total questions",                 threshold: 10,   stat: "total"     },
  { id: "fifty_questions",   icon: "üåü", name: "Fifty Questions",   desc: "Reach 50 total questions",                 threshold: 50,   stat: "total"     },
  { id: "century",           icon: "üíØ", name: "Century",           desc: "Add 100 total questions",                  threshold: 100,  stat: "total"     },
  { id: "five_hundred",      icon: "üè∞", name: "Grand Archive",     desc: "Add 500 total questions",                  threshold: 500,  stat: "total"     },
  { id: "daily_hero",        icon: "‚ö°", name: "Daily Hero",        desc: "Add 10 questions in a single day",          threshold: 10,   stat: "today"     },
  { id: "daily_master",      icon: "üî•", name: "Daily Master",      desc: "Add 25 questions in a single day",          threshold: 25,   stat: "today"     },
  { id: "daily_legend",      icon: "üåä", name: "Daily Legend",      desc: "Add 50 questions in a single day",          threshold: 50,   stat: "today"     },
  { id: "streak_3",          icon: "üó°Ô∏è", name: "3-Day Streak",      desc: "Maintain a 3-day active streak",            threshold: 3,    stat: "streak"    },
  { id: "streak_7",          icon: "‚öîÔ∏è", name: "Week Warrior",      desc: "Maintain a 7-day active streak",            threshold: 7,    stat: "streak"    },
  { id: "streak_30",         icon: "üëë", name: "Month Champion",    desc: "Maintain a 30-day active streak",           threshold: 30,   stat: "streak"    },
  { id: "level_5",           icon: "üßô", name: "Reasoning Mage",    desc: "Reach Level 5",                            threshold: 5,    stat: "level"     },
  { id: "level_10",          icon: "üèÜ", name: "Polymath Legend",   desc: "Reach the maximum Level 10",               threshold: 10,   stat: "level"     },
  { id: "weekly_50",         icon: "üìö", name: "Weekly Scholar",    desc: "Add 50 questions in one week",             threshold: 50,   stat: "week"      },
  { id: "task_starter",      icon: "‚úÖ", name: "Task Starter",      desc: "Complete your first todo task",            threshold: 1,    stat: "tasks"     },
  { id: "task_commander",    icon: "üìå", name: "Task Commander",    desc: "Complete 25 todo tasks",                   threshold: 25,   stat: "tasks"     },
  { id: "loot_hunter",       icon: "üß∞", name: "Loot Hunter",       desc: "Collect 10 inventory items",               threshold: 10,   stat: "items"     },
  { id: "arena_winner",      icon: "‚öîÔ∏è", name: "Arena Winner",      desc: "Win 3 mini-game battles",                  threshold: 3,    stat: "wins"      },
  { id: "arena_champion",    icon: "üõ°Ô∏è", name: "Arena Champion",    desc: "Win 15 mini-game battles",                 threshold: 15,   stat: "wins"      },
];

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   MILESTONE DEFINITIONS
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const MILESTONES = [
  { id: "m10",  label: "10 Questions",    target: 10  },
  { id: "m25",  label: "25 Questions",    target: 25  },
  { id: "m50",  label: "50 Questions",    target: 50  },
  { id: "m100", label: "100 Questions",   target: 100 },
  { id: "m250", label: "250 Questions",   target: 250 },
  { id: "m500", label: "500 Questions",   target: 500 },
];

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   APP STATE
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
let currentUser = null;
let userData    = null;        // live Firestore doc data
let activeTab   = 'daily';
let isAdding    = false;       // debounce flag
let userDocUnsubscribe = null;

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   UTILITY HELPERS
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

function getDateKey(date = new Date()) {
  return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
}

function getWeekKey(date = new Date()) {
  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const dayNum = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
  const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  return `${d.getUTCFullYear()}-W${String(weekNo).padStart(2,'0')}`;
}

function getMonthKey(date = new Date()) {
  return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2,'0')}`;
}

function getYearKey(date = new Date()) {
  return `${date.getFullYear()}`;
}

function getLevelInfo(totalXP) {
  let currentLevel = LEVEL_CONFIG[0];
  for (const cfg of LEVEL_CONFIG) {
    if (totalXP >= cfg.xpRequired) currentLevel = cfg;
    else break;
  }
  return currentLevel;
}

function getXpForLevel(totalXP) {
  const info = getLevelInfo(totalXP);
  const xpIntoLevel = totalXP - info.xpRequired;
  const pct = Math.min(100, (xpIntoLevel / info.xpNeeded) * 100);
  return { info, xpIntoLevel, pct };
}

function formatTime(ts) {
  if (!ts) return '';
  const d = ts.toDate ? ts.toDate() : new Date(ts);
  const h = d.getHours(), m = d.getMinutes(), s = d.getSeconds();
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

function randomInt(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

function sample(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}

function randomId(prefix = 'id') {
  return `${prefix}_${Date.now()}_${Math.random().toString(36).slice(2, 8)}`;
}

function escapeHtml(str) {
  return String(str)
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#39;');
}

function rollSkills(count = 3) {
  const clone = [...SKILL_POOL];
  const picked = [];
  while (clone.length && picked.length < count) {
    const i = randomInt(0, clone.length - 1);
    picked.push(clone[i]);
    clone.splice(i, 1);
  }
  return picked;
}

function createRandomItem() {
  const template = sample(ITEM_TEMPLATES);
  return {
    id: randomId('item'),
    slot: template.slot,
    name: sample(template.names),
    atk: randomInt(template.atk[0], template.atk[1]),
    def: randomInt(template.def[0], template.def[1]),
    rarity: sample(['Common', 'Magic', 'Rare']),
    createdAt: new Date().toISOString(),
  };
}

function getBaseEquipment() {
  return EQUIPMENT_SLOTS.reduce((acc, slot) => {
    acc[slot] = null;
    return acc;
  }, {});
}

function ensureRpgDefaults(data) {
  data.todoTasks = Array.isArray(data.todoTasks) ? data.todoTasks : [];
  data.completedTasks = Number(data.completedTasks || 0);
  data.inventory = Array.isArray(data.inventory) ? data.inventory : [];
  data.equipment = data.equipment && typeof data.equipment === 'object' ? data.equipment : {};
  for (const slot of EQUIPMENT_SLOTS) {
    if (!Object.prototype.hasOwnProperty.call(data.equipment, slot)) data.equipment[slot] = null;
  }
  data.skills = Array.isArray(data.skills) && data.skills.length ? data.skills : rollSkills(3);
  data.miniGame = data.miniGame && typeof data.miniGame === 'object' ? data.miniGame : {};
  data.miniGame.wins = Number(data.miniGame.wins || 0);
  data.miniGame.plays = Number(data.miniGame.plays || 0);
  data.miniGame.inBattle = !!data.miniGame.inBattle;
  data.miniGame.playerHp = Number(data.miniGame.playerHp || 100);
  data.miniGame.enemyHp = Number(data.miniGame.enemyHp || 0);
  data.miniGame.enemyMaxHp = Number(data.miniGame.enemyMaxHp || 0);
  data.miniGame.enemyPower = Number(data.miniGame.enemyPower || 0);
  data.miniGame.enemyName = data.miniGame.enemyName || '';
  data.miniGame.log = data.miniGame.log || 'No battle yet. Start one to enter the arena.';
}

function getCharacterStats() {
  const equipment = userData.equipment || {};
  const totalAtk = EQUIPMENT_SLOTS.reduce((sum, slot) => sum + Number((equipment[slot] && equipment[slot].atk) || 0), 0);
  const totalDef = EQUIPMENT_SLOTS.reduce((sum, slot) => sum + Number((equipment[slot] && equipment[slot].def) || 0), 0);
  const level = getLevelInfo(userData.totalXP || 0).level;
  return {
    maxHp: 100 + level * 8 + totalDef * 2,
    atk: 8 + level * 2 + totalAtk,
    def: 3 + Math.floor(level / 2) + totalDef,
  };
}

function getCharacterStatsFromData(data) {
  const equipment = data.equipment || {};
  const totalAtk = EQUIPMENT_SLOTS.reduce((sum, slot) => sum + Number((equipment[slot] && equipment[slot].atk) || 0), 0);
  const totalDef = EQUIPMENT_SLOTS.reduce((sum, slot) => sum + Number((equipment[slot] && equipment[slot].def) || 0), 0);
  const level = getLevelInfo(data.totalXP || 0).level;
  return {
    maxHp: 100 + level * 8 + totalDef * 2,
    atk: 8 + level * 2 + totalAtk,
    def: 3 + Math.floor(level / 2) + totalDef,
  };
}

function mergeCountMaps(serverMap = {}, localMap = {}) {
  const merged = { ...serverMap };
  for (const [k, v] of Object.entries(localMap || {})) {
    merged[k] = Math.max(Number(merged[k] || 0), Number(v || 0));
  }
  return merged;
}

function mergeTaskLists(serverTasks = [], localTasks = []) {
  const byId = {};
  for (const task of [...serverTasks, ...localTasks]) {
    if (!task || !task.id) continue;
    const prev = byId[task.id];
    if (!prev) byId[task.id] = { ...task };
    else {
      byId[task.id] = {
        ...prev,
        ...task,
        completed: !!(prev.completed || task.completed),
        completedAt: prev.completedAt || task.completedAt || null,
      };
    }
  }
  return Object.values(byId)
    .sort((a, b) => String(b.createdAt || '').localeCompare(String(a.createdAt || '')))
    .slice(0, 200);
}

function mergeInventory(serverInventory = [], localInventory = []) {
  const byId = {};
  for (const item of [...serverInventory, ...localInventory]) {
    if (!item || !item.id) continue;
    byId[item.id] = byId[item.id] ? { ...byId[item.id], ...item } : { ...item };
  }
  return Object.values(byId)
    .sort((a, b) => String(b.createdAt || '').localeCompare(String(a.createdAt || '')))
    .slice(0, 300);
}

function mergeRecentLog(serverLog = [], localLog = []) {
  const seen = new Set();
  const merged = [];
  for (const entry of [...localLog, ...serverLog]) {
    if (!entry) continue;
    const key = `${entry.ts || ''}|${entry.text || ''}|${entry.xp || 0}`;
    if (seen.has(key)) continue;
    seen.add(key);
    merged.push(entry);
  }
  return merged
    .sort((a, b) => String(b.ts || '').localeCompare(String(a.ts || '')))
    .slice(0, 50);
}

function mergeUserRecords(serverData = {}, localData = {}) {
  const merged = {
    totalXP: Math.max(Number(serverData.totalXP || 0), Number(localData.totalXP || 0)),
    totalQuestions: Math.max(Number(serverData.totalQuestions || 0), Number(localData.totalQuestions || 0)),
    streak: Math.max(Number(serverData.streak || 0), Number(localData.streak || 0)),
    longestStreak: Math.max(Number(serverData.longestStreak || 0), Number(localData.longestStreak || 0)),
    completedTasks: Math.max(Number(serverData.completedTasks || 0), Number(localData.completedTasks || 0)),
    lastActiveDate: String(serverData.lastActiveDate || '') > String(localData.lastActiveDate || '')
      ? serverData.lastActiveDate
      : localData.lastActiveDate,
    dailyCounts: mergeCountMaps(serverData.dailyCounts, localData.dailyCounts),
    weeklyCounts: mergeCountMaps(serverData.weeklyCounts, localData.weeklyCounts),
    monthlyCounts: mergeCountMaps(serverData.monthlyCounts, localData.monthlyCounts),
    yearlyCounts: mergeCountMaps(serverData.yearlyCounts, localData.yearlyCounts),
    achievements: { ...(serverData.achievements || {}), ...(localData.achievements || {}) },
    recentLog: mergeRecentLog(serverData.recentLog, localData.recentLog),
    todoTasks: mergeTaskLists(serverData.todoTasks, localData.todoTasks),
    inventory: mergeInventory(serverData.inventory, localData.inventory),
    equipment: getBaseEquipment(),
    skills: (localData.skills && localData.skills.length) ? localData.skills : ((serverData.skills && serverData.skills.length) ? serverData.skills : rollSkills(3)),
    miniGame: {
      wins: Math.max(Number((serverData.miniGame && serverData.miniGame.wins) || 0), Number((localData.miniGame && localData.miniGame.wins) || 0)),
      plays: Math.max(Number((serverData.miniGame && serverData.miniGame.plays) || 0), Number((localData.miniGame && localData.miniGame.plays) || 0)),
      inBattle: false,
      playerHp: Math.max(Number((serverData.miniGame && serverData.miniGame.playerHp) || 100), Number((localData.miniGame && localData.miniGame.playerHp) || 100)),
      enemyHp: 0,
      enemyMaxHp: 0,
      enemyPower: 0,
      enemyName: '',
      log: (localData.miniGame && localData.miniGame.log) || (serverData.miniGame && serverData.miniGame.log) || 'No battle yet. Start one to enter the arena.',
    },
  };

  for (const slot of EQUIPMENT_SLOTS) {
    const localItem = localData.equipment && localData.equipment[slot];
    const serverItem = serverData.equipment && serverData.equipment[slot];
    merged.equipment[slot] = localItem || serverItem || null;
  }

  return merged;
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   AUTH FUNCTIONS
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

function signInWithGoogle() {
  const provider = new firebase.auth.GoogleAuthProvider();
  provider.setCustomParameters({ login_hint: 'chungzhikai@gmail.com' });
  auth.signInWithPopup(provider).catch(err => {
    console.error("Sign in error:", err);
    alert("Sign-in failed: " + err.message);
  });
}

function signOut() {
  auth.signOut().then(() => {
    if (userDocUnsubscribe) {
      userDocUnsubscribe();
      userDocUnsubscribe = null;
    }
    currentUser = null;
    userData    = null;
    showScreen('login');
  });
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   SCREEN MANAGEMENT
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

function showScreen(name) {
  document.getElementById('loading-screen').style.display = 'none';
  document.getElementById('login-screen').style.display   = 'none';
  document.getElementById('main-app').classList.remove('visible');

  if (name === 'loading') {
    document.getElementById('loading-screen').style.display = 'flex';
  } else if (name === 'login') {
    document.getElementById('login-screen').style.display = 'flex';
  } else if (name === 'main') {
    document.getElementById('main-app').classList.add('visible');
  }
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   FIRESTORE DATA STRUCTURE
   userData = {
     totalXP: number,
     totalQuestions: number,
     streak: number,
     lastActiveDate: string,
     longestStreak: number,
     dailyCounts: { "2025-01-01": 5, ... },
     weeklyCounts: { "2025-W01": 20, ... },
     monthlyCounts: { "2025-01": 100, ... },
     yearlyCounts: { "2025": 400, ... },
     achievements: { "first_question": true, ... },
     recentLog: [ { ts, text, xp }, ... ]   (max 50)
   }
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

async function loadUserData(uid) {
  const ref = db.collection('cerquest_users').doc(uid);
  const snap = await ref.get();
  if (snap.exists) {
    return { ...snap.data(), _ref: ref };
  } else {
    const fresh = {
      totalXP:        0,
      totalQuestions: 0,
      streak:         0,
      lastActiveDate: null,
      longestStreak:  0,
      dailyCounts:    {},
      weeklyCounts:   {},
      monthlyCounts:  {},
      yearlyCounts:   {},
      achievements:   {},
      recentLog:      [],
      todoTasks:      [],
      completedTasks: 0,
      inventory:      [],
      equipment:      getBaseEquipment(),
      skills:         rollSkills(3),
      miniGame: {
        wins: 0,
        plays: 0,
        inBattle: false,
        playerHp: 100,
        enemyHp: 0,
        enemyMaxHp: 0,
        enemyPower: 0,
        enemyName: '',
        log: 'No battle yet. Start one to enter the arena.',
      },
    };
    await ref.set(fresh);
    return { ...fresh, _ref: ref };
  }
}

async function saveUserData() {
  if (!userData || !userData._ref) return;
  const { _ref, ...localData } = userData;
  const serverSnap = await _ref.get();
  const serverData = serverSnap.exists ? serverSnap.data() : {};
  const merged = mergeUserRecords(serverData, localData);
  merged.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
  await _ref.set(merged, { merge: true });
  userData = { ...merged, _ref };
}

function startUserDataSync(uid) {
  if (userDocUnsubscribe) {
    userDocUnsubscribe();
    userDocUnsubscribe = null;
  }
  const ref = db.collection('cerquest_users').doc(uid);
  userDocUnsubscribe = ref.onSnapshot((snap) => {
    if (!snap.exists) return;
    const incoming = { ...snap.data(), _ref: ref };
    if (!userData) {
      userData = incoming;
    } else {
      userData = { ...mergeUserRecords(userData, incoming), _ref: ref };
    }
    ensureRpgDefaults(userData);
    if (currentUser) renderAll();
  }, (err) => {
    console.error('Live sync error:', err);
  });
}

async function runUserTransaction(mutator) {
  if (!currentUser) throw new Error('Not signed in');
  const ref = db.collection('cerquest_users').doc(currentUser.uid);
  const txResult = await db.runTransaction(async (tx) => {
    const snap = await tx.get(ref);
    const base = snap.exists ? snap.data() : {};
    ensureRpgDefaults(base);
    const result = mutator(base) || {};
    base.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
    tx.set(ref, base, { merge: true });
    return { data: base, result };
  });
  userData = { ...txResult.data, _ref: ref };
  ensureRpgDefaults(userData);
  return txResult.result;
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   STREAK LOGIC
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

function updateStreakForData(data) {
  const today     = getDateKey();
  const yesterday = getDateKey(new Date(Date.now() - 86400000));

  if (data.lastActiveDate === today) {
    // Already counted today ‚Äì no change
    return;
  } else if (data.lastActiveDate === yesterday) {
    // Extend streak
    data.streak += 1;
  } else if (data.lastActiveDate === null) {
    // First ever
    data.streak = 1;
  } else {
    // Streak broken
    data.streak = 1;
  }

  data.lastActiveDate = today;
  if (data.streak > (data.longestStreak || 0)) {
    data.longestStreak = data.streak;
  }
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   ACHIEVEMENT CHECKER
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

function checkAchievementsForData(data) {
  const newlyUnlocked = [];
  const today = getDateKey();
  const weekKey = getWeekKey();
  const levelInfo = getLevelInfo(data.totalXP);

  const statMap = {
    total:  data.totalQuestions,
    today:  data.dailyCounts[today] || 0,
    streak: data.streak,
    level:  levelInfo.level,
    week:   data.weeklyCounts[weekKey] || 0,
    tasks:  data.completedTasks || 0,
    items:  (data.inventory || []).length + EQUIPMENT_SLOTS.filter((slot) => !!data.equipment[slot]).length,
    wins:   (data.miniGame && data.miniGame.wins) || 0,
  };

  for (const ach of ACHIEVEMENTS_DEF) {
    if (!data.achievements[ach.id]) {
      const val = statMap[ach.stat] || 0;
      if (val >= ach.threshold) {
        data.achievements[ach.id] = true;
        newlyUnlocked.push(ach);
      }
    }
  }

  return newlyUnlocked;
}

function checkAchievements() {
  return checkAchievementsForData(userData);
}

function addLogEntryToData(data, text, xp) {
  const logEntry = {
    ts: new Date().toISOString(),
    text,
    xp: Number(xp || 0),
  };
  data.recentLog = [logEntry, ...(data.recentLog || [])].slice(0, 50);
}

function addLogEntry(text, xp) {
  addLogEntryToData(userData, text, xp);
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   CORE: ADD QUESTION
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

async function addQuestion() {
  if (!currentUser || !userData || isAdding) return;
  isAdding = true;

  // Button animation
  const btn = document.getElementById('add-btn');
  btn.classList.add('animate');
  setTimeout(() => btn.classList.remove('animate'), 400);

  // Ripple
  spawnRipple();

  let xpGained = 0;
  let prevLevel = 0;
  let newLevel = 0;
  let newBadges = [];
  try {
    const result = await runUserTransaction((data) => {
      const today = getDateKey();
      const weekKey = getWeekKey();
      const monthKey = getMonthKey();
      const yearKey = getYearKey();

      data.totalQuestions = (data.totalQuestions || 0) + 1;
      data.dailyCounts[today] = (data.dailyCounts[today] || 0) + 1;
      data.weeklyCounts[weekKey] = (data.weeklyCounts[weekKey] || 0) + 1;
      data.monthlyCounts[monthKey] = (data.monthlyCounts[monthKey] || 0) + 1;
      data.yearlyCounts[yearKey] = (data.yearlyCounts[yearKey] || 0) + 1;

      const todayCount = data.dailyCounts[today];
      let gained = XP_BASE;
      if (todayCount % 10 === 0) gained *= 2;
      if (todayCount % 25 === 0) gained *= 3;

      const previousLevel = getLevelInfo(data.totalXP || 0).level;
      data.totalXP = (data.totalXP || 0) + gained;
      const currentLevel = getLevelInfo(data.totalXP || 0).level;

      updateStreakForData(data);
      addLogEntryToData(data, `Added question #${data.totalQuestions}`, gained);
      const badges = checkAchievementsForData(data);
      return { gained, previousLevel, currentLevel, badges };
    });
    xpGained = result.gained;
    prevLevel = result.previousLevel;
    newLevel = result.currentLevel;
    newBadges = result.badges;
  } catch (e) {
    console.error("Save error:", e);
    isAdding = false;
    return;
  }

  // Show XP popup
  showXpPopup(xpGained, btn);

  // Level up?
  if (newLevel > prevLevel) {
    const levelInfo = getLevelInfo(userData.totalXP || 0);
    setTimeout(() => showLevelUpToast(newLevel, levelInfo.title), 600);
    launchConfetti();
  }

  // Badge popup (if unlocked multiple, show first)
  if (newBadges.length > 0 && newLevel === prevLevel) {
    setTimeout(() => showBadgeToast(newBadges[0]), 600);
  }

  // Update UI
  renderAll();

  setTimeout(() => { isAdding = false; }, 300);
}

async function addTask() {
  if (!userData || !currentUser) return;
  const titleInput = document.getElementById('task-title-input');
  const importanceInput = document.getElementById('task-importance-input');
  const title = titleInput.value.trim();
  const importance = Number(importanceInput.value || TASK_IMPORTANCE_MIN);

  if (!title) return;
  if (importance < TASK_IMPORTANCE_MIN || importance > TASK_IMPORTANCE_MAX) {
    alert(`Importance must be between ${TASK_IMPORTANCE_MIN} and ${TASK_IMPORTANCE_MAX}.`);
    return;
  }

  userData.todoTasks.unshift({
    id: randomId('task'),
    title,
    importance,
    completed: false,
    createdAt: new Date().toISOString(),
    completedAt: null,
  });
  userData.todoTasks = userData.todoTasks.slice(0, 200);

  addLogEntry(`Added todo task: ${title}`, 0);
  titleInput.value = '';
  importanceInput.value = String(TASK_IMPORTANCE_MAX);
  await saveUserData();
  renderAll();
}

async function completeTask(taskId) {
  if (!userData || !currentUser) return;
  let xp = 0;
  let prevLevel = 0;
  let newLevel = 0;
  let newBadges = [];
  let changed = false;

  const result = await runUserTransaction((data) => {
    const task = (data.todoTasks || []).find((t) => t.id === taskId);
    if (!task || task.completed) {
      return { changed: false, xp: 0, prevLevel: getLevelInfo(data.totalXP || 0).level, newLevel: getLevelInfo(data.totalXP || 0).level, badges: [] };
    }

    task.completed = true;
    task.completedAt = new Date().toISOString();
    data.completedTasks = (data.completedTasks || 0) + 1;

    const gained = task.importance * 4;
    const previousLevel = getLevelInfo(data.totalXP || 0).level;
    data.totalXP = (data.totalXP || 0) + gained;
    const currentLevel = getLevelInfo(data.totalXP || 0).level;

    const loot = createRandomItem();
    data.inventory.unshift(loot);

    addLogEntryToData(data, `Completed task: ${task.title} (Imp ${task.importance})`, gained);
    addLogEntryToData(data, `Loot gained: ${loot.name} [${loot.slot}]`, 0);
    const badges = checkAchievementsForData(data);
    return { changed: true, xp: gained, prevLevel: previousLevel, newLevel: currentLevel, badges };
  });

  changed = result.changed;
  xp = result.xp;
  prevLevel = result.prevLevel;
  newLevel = result.newLevel;
  newBadges = result.badges;
  if (!changed) return;

  renderAll();
  showXpPopup(xp, document.getElementById('level-number'));

  if (newLevel > prevLevel) {
    const info = getLevelInfo(userData.totalXP);
    showLevelUpToast(newLevel, info.title);
    launchConfetti();
  } else if (newBadges.length > 0) {
    showBadgeToast(newBadges[0]);
  }
}

async function equipItem(itemId) {
  if (!userData || !currentUser) return;
  const idx = userData.inventory.findIndex((it) => it.id === itemId);
  if (idx < 0) return;
  const item = userData.inventory[idx];
  const slot = item.slot;
  const currentlyEquipped = userData.equipment[slot];

  if (currentlyEquipped) {
    userData.inventory.unshift(currentlyEquipped);
  }
  userData.equipment[slot] = item;
  userData.inventory.splice(idx, 1);
  addLogEntry(`Equipped ${item.name} to ${slot}`, 0);
  await saveUserData();
  renderAll();
}

async function unequipSlot(slot) {
  if (!userData || !currentUser) return;
  const item = userData.equipment[slot];
  if (!item) return;
  userData.inventory.unshift(item);
  userData.equipment[slot] = null;
  addLogEntry(`Unequipped ${item.name} from ${slot}`, 0);
  await saveUserData();
  renderAll();
}

async function rerollSkills() {
  if (!userData || !currentUser) return;
  userData.skills = rollSkills(3);
  addLogEntry(`Rerolled random skills`, 0);
  await saveUserData();
  renderAll();
}

async function startBattle() {
  if (!userData || !currentUser) return;
  await runUserTransaction((data) => {
    const stats = getCharacterStatsFromData(data);
    const level = getLevelInfo(data.totalXP || 0).level;
    const enemyLevel = Math.max(1, level + randomInt(-1, 2));
    data.miniGame.inBattle = true;
    data.miniGame.playerHp = stats.maxHp;
    data.miniGame.enemyMaxHp = 60 + enemyLevel * 14 + randomInt(0, 18);
    data.miniGame.enemyHp = data.miniGame.enemyMaxHp;
    data.miniGame.enemyPower = 6 + enemyLevel * 2;
    data.miniGame.enemyName = sample(['Blood Wraith', 'Ash Reaver', 'Crypt Fiend', 'Storm Ghoul']);
    data.miniGame.log = `${data.miniGame.enemyName} appears with ${data.miniGame.enemyHp} HP.`;
  });
  renderMiniGame();
}

async function battleAttack() {
  await resolveBattleTurn(false);
}

async function battleSkill() {
  await resolveBattleTurn(true);
}

async function resolveBattleTurn(useSkill) {
  if (!userData || !currentUser) return;
  const result = await runUserTransaction((data) => {
    if (!data.miniGame.inBattle) {
      data.miniGame.log = 'Start a battle first.';
      return { won: false, badges: [] };
    }

    const stats = getCharacterStatsFromData(data);
    let damage = stats.atk + randomInt(2, 7);
    let skillText = '';
    if (useSkill && data.skills.length) {
      const skill = sample(data.skills);
      damage = Math.round(damage * Number(skill.power || 1.5));
      skillText = ` using ${skill.name}`;
    }

    data.miniGame.enemyHp = Math.max(0, data.miniGame.enemyHp - damage);
    if (data.miniGame.enemyHp <= 0) {
      const winXp = 25 + randomInt(0, 20);
      data.totalXP = (data.totalXP || 0) + winXp;
      data.miniGame.wins = (data.miniGame.wins || 0) + 1;
      data.miniGame.plays = (data.miniGame.plays || 0) + 1;
      data.miniGame.inBattle = false;
      const loot = createRandomItem();
      data.inventory.unshift(loot);
      data.miniGame.log = `You dealt ${damage}${skillText} and defeated ${data.miniGame.enemyName}. +${winXp} XP and loot: ${loot.name}.`;
      addLogEntryToData(data, `Won arena battle vs ${data.miniGame.enemyName}`, winXp);
      const badges = checkAchievementsForData(data);
      return { won: true, badges };
    }

    const enemyDamage = Math.max(1, data.miniGame.enemyPower + randomInt(0, 5) - stats.def);
    data.miniGame.playerHp = Math.max(0, data.miniGame.playerHp - enemyDamage);

    if (data.miniGame.playerHp <= 0) {
      data.miniGame.inBattle = false;
      data.miniGame.plays = (data.miniGame.plays || 0) + 1;
      data.miniGame.log = `You dealt ${damage}${skillText}, but ${data.miniGame.enemyName} defeated you.`;
      addLogEntryToData(data, `Lost arena battle vs ${data.miniGame.enemyName}`, 0);
    } else {
      data.miniGame.log = `You hit for ${damage}${skillText}. ${data.miniGame.enemyName} hits back for ${enemyDamage}.`;
    }
    return { won: false, badges: [] };
  });

  renderAll();
  if (result.won && result.badges.length) showBadgeToast(result.badges[0]);
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   XP POPUP ANIMATION
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

function showXpPopup(xp, anchor) {
  const rect = anchor.getBoundingClientRect();
  const el = document.createElement('div');
  el.className = 'xp-popup';
  el.textContent = `+${xp} XP`;
  el.style.left = `${rect.left + rect.width / 2}px`;
  el.style.top  = `${rect.top}px`;
  if (xp > XP_BASE) el.style.color = '#00e5ff';
  document.body.appendChild(el);
  el.addEventListener('animationend', () => el.remove());
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   RIPPLE ANIMATION
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

function spawnRipple() {
  const container = document.getElementById('ripple-container');
  for (let i = 0; i < 3; i++) {
    const ring = document.createElement('div');
    ring.className = 'ripple-ring';
    ring.style.animationDelay = `${i * 0.15}s`;
    container.appendChild(ring);
    ring.addEventListener('animationend', () => ring.remove());
  }
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   LEVEL UP TOAST
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

function showLevelUpToast(level, title) {
  document.getElementById('toast-level-text').textContent = `LEVEL ${level} ‚Äî ${title.toUpperCase()}`;
  document.getElementById('toast-title-text').textContent = `You have ascended to become a ${title}!`;
  document.getElementById('toast-overlay').classList.add('show');
  document.getElementById('level-up-toast').classList.add('show');
}

function showBadgeToast(badge) {
  document.getElementById('toast-level-text').textContent = `üèÖ ACHIEVEMENT UNLOCKED`;
  document.getElementById('toast-title-text').textContent = `${badge.icon} ${badge.name} ‚Äî ${badge.desc}`;
  document.getElementById('toast-overlay').classList.add('show');
  document.getElementById('level-up-toast').classList.add('show');
}

function closeLevelUpToast() {
  document.getElementById('toast-overlay').classList.remove('show');
  document.getElementById('level-up-toast').classList.remove('show');
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   CONFETTI
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

function launchConfetti() {
  const canvas = document.getElementById('confetti-canvas');
  const ctx    = canvas.getContext('2d');
  canvas.width  = window.innerWidth;
  canvas.height = window.innerHeight;

  const pieces = Array.from({ length: 120 }, () => ({
    x:   Math.random() * canvas.width,
    y:   Math.random() * canvas.height * 0.3 - 50,
    vx:  (Math.random() - 0.5) * 6,
    vy:  Math.random() * 4 + 2,
    r:   Math.random() * 7 + 3,
    color: ['#f5c842','#00e5ff','#a855f7','#22c55e','#f97316'][Math.floor(Math.random() * 5)],
    rot: Math.random() * Math.PI * 2,
    rv:  (Math.random() - 0.5) * 0.2,
    alive: true,
  }));

  let frame = 0;
  function step() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    let anyAlive = false;
    for (const p of pieces) {
      if (!p.alive) continue;
      anyAlive = true;
      p.x  += p.vx;
      p.y  += p.vy;
      p.rot += p.rv;
      p.vy += 0.07;
      if (p.y > canvas.height + 20) { p.alive = false; continue; }
      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot);
      ctx.fillStyle = p.color;
      ctx.globalAlpha = Math.max(0, 1 - frame / 180);
      ctx.fillRect(-p.r / 2, -p.r / 2, p.r, p.r);
      ctx.restore();
    }
    frame++;
    if (anyAlive && frame < 200) requestAnimationFrame(step);
    else ctx.clearRect(0, 0, canvas.width, canvas.height);
  }
  requestAnimationFrame(step);
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   TAB SWITCHING
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

function switchTab(tab) {
  activeTab = tab;
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => {
    if (b.textContent.toLowerCase().startsWith(tab)) b.classList.add('active');
  });
  renderStats();
  renderChart();
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   RENDER: MAIN
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

function renderAll() {
  if (!userData) return;
  renderLevelCard();
  renderStreakCard();
  renderTodayCount();
  renderStats();
  renderChart();
  renderMilestones();
  renderAchievements();
  renderTodoList();
  renderRpgPanel();
  renderMiniGame();
  renderLog();
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   RENDER: LEVEL CARD
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

function renderLevelCard() {
  const { info, xpIntoLevel, pct } = getXpForLevel(userData.totalXP || 0);

  document.getElementById('level-number').textContent = info.level;
  document.getElementById('rank-title').textContent   = info.title;
  document.getElementById('xp-display').textContent   =
    `${userData.totalXP || 0} total ¬∑ ${xpIntoLevel} / ${info.xpNeeded} XP`;
  document.getElementById('xp-bar').style.width = `${pct}%`;
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   RENDER: STREAK CARD
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

function renderStreakCard() {
  const streak = userData.streak || 0;
  document.getElementById('streak-number').textContent = streak;

  const container = document.getElementById('streak-days-row');
  container.innerHTML = '';
  const today = getDateKey();
  const days  = ['M','T','W','T','F','S','S'];

  // Show last 14 days
  for (let i = 13; i >= 0; i--) {
    const d    = new Date(Date.now() - i * 86400000);
    const key  = getDateKey(d);
    const count= userData.dailyCounts[key] || 0;
    const dot  = document.createElement('div');
    dot.className = 'streak-day-dot';
    dot.title = `${key}: ${count} questions`;
    if (key === today)   { dot.classList.add('today');  dot.textContent = '‚òÖ'; }
    else if (count > 0)  { dot.classList.add('active');  dot.textContent = '‚úì'; }
    else                 { dot.textContent = '¬∑'; }
    container.appendChild(dot);
  }
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   RENDER: TODAY COUNT
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

function renderTodayCount() {
  const today = getDateKey();
  document.getElementById('today-count').textContent =
    userData.dailyCounts[today] || 0;
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   RENDER: STATS GRID
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

function renderStats() {
  const grid = document.getElementById('stats-grid');
  grid.innerHTML = '';

  const today      = getDateKey();
  const weekKey    = getWeekKey();
  const monthKey   = getMonthKey();
  const yearKey    = getYearKey();

  let cards = [];

  if (activeTab === 'daily') {
    const todayCount = userData.dailyCounts[today] || 0;
    // Best day ever
    const bestDay = Math.max(...Object.values(userData.dailyCounts || {}).map(v => Number(v)), 0);
    cards = [
      { icon: 'üìù', label: 'Today',         value: todayCount },
      { icon: '‚≠ê', label: 'Best Day',       value: bestDay },
      { icon: 'üî•', label: 'Streak',         value: userData.streak || 0 },
      { icon: '‚ú®', label: 'XP Today',       value: todayCount * XP_BASE },
    ];
  } else if (activeTab === 'weekly') {
    const thisWeek = userData.weeklyCounts[weekKey] || 0;
    const allWeeks = Object.values(userData.weeklyCounts || {}).map(v => Number(v));
    const bestWeek = allWeeks.length ? Math.max(...allWeeks) : 0;
    const avgWeek  = allWeeks.length ? Math.round(allWeeks.reduce((a,b)=>a+b,0)/allWeeks.length) : 0;
    cards = [
      { icon: 'üìÖ', label: 'This Week',      value: thisWeek },
      { icon: 'üèÜ', label: 'Best Week',      value: bestWeek },
      { icon: 'üìä', label: 'Weekly Avg',     value: avgWeek },
      { icon: 'üî¢', label: 'Total',          value: userData.totalQuestions || 0 },
    ];
  } else if (activeTab === 'monthly') {
    const thisMonth = userData.monthlyCounts[monthKey] || 0;
    const allMonths = Object.values(userData.monthlyCounts || {}).map(v => Number(v));
    const bestMonth = allMonths.length ? Math.max(...allMonths) : 0;
    const avgMonth  = allMonths.length ? Math.round(allMonths.reduce((a,b)=>a+b,0)/allMonths.length) : 0;
    cards = [
      { icon: 'üóìÔ∏è', label: 'This Month',    value: thisMonth },
      { icon: 'ü•á', label: 'Best Month',    value: bestMonth },
      { icon: 'üìà', label: 'Monthly Avg',   value: avgMonth },
      { icon: 'üéØ', label: 'Months Active', value: allMonths.length },
    ];
  } else if (activeTab === 'yearly') {
    const thisYear  = userData.yearlyCounts[yearKey] || 0;
    const allYears  = Object.values(userData.yearlyCounts || {}).map(v => Number(v));
    const bestYear  = allYears.length ? Math.max(...allYears) : 0;
    cards = [
      { icon: 'üåç', label: 'This Year',     value: thisYear },
      { icon: 'üëë', label: 'Best Year',     value: bestYear },
      { icon: 'üíé', label: 'Total XP',      value: userData.totalXP || 0 },
      { icon: 'üìú', label: 'All Questions', value: userData.totalQuestions || 0 },
    ];
  }

  for (const c of cards) {
    const card = document.createElement('div');
    card.className = 'stat-card';
    card.innerHTML = `
      <span class="stat-card-icon">${c.icon}</span>
      <div class="stat-card-value">${c.value}</div>
      <div class="stat-card-label">${c.label}</div>
    `;
    grid.appendChild(card);
  }
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   RENDER: BAR CHART
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

function renderChart() {
  const chart = document.getElementById('bar-chart');
  const title = document.getElementById('chart-title');
  chart.innerHTML = '';

  let labels = [];
  let values = [];

  if (activeTab === 'daily') {
    title.textContent = 'Last 14 Days';
    for (let i = 13; i >= 0; i--) {
      const d   = new Date(Date.now() - i * 86400000);
      const key = getDateKey(d);
      labels.push(d.getDate());
      values.push(userData.dailyCounts[key] || 0);
    }
  } else if (activeTab === 'weekly') {
    title.textContent = 'Last 12 Weeks';
    for (let i = 11; i >= 0; i--) {
      const d   = new Date(Date.now() - i * 7 * 86400000);
      const key = getWeekKey(d);
      labels.push(`W${i===0?'now':11-i+1}`);
      values.push(userData.weeklyCounts[key] || 0);
    }
  } else if (activeTab === 'monthly') {
    title.textContent = 'Last 12 Months';
    const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    for (let i = 11; i >= 0; i--) {
      const d = new Date();
      d.setMonth(d.getMonth() - i);
      const key = getMonthKey(d);
      labels.push(monthNames[d.getMonth()]);
      values.push(userData.monthlyCounts[key] || 0);
    }
  } else if (activeTab === 'yearly') {
    title.textContent = 'Yearly Overview';
    const curYear = new Date().getFullYear();
    for (let y = curYear - 3; y <= curYear; y++) {
      labels.push(y);
      values.push(userData.yearlyCounts[String(y)] || 0);
    }
  }

  const maxVal = Math.max(...values, 1);
  const todayKey = getDateKey();

  labels.forEach((lbl, i) => {
    const val = values[i];
    const pct = (val / maxVal) * 100;

    let isToday = false;
    if (activeTab === 'daily') {
      const d = new Date(Date.now() - (labels.length - 1 - i) * 86400000);
      isToday = getDateKey(d) === todayKey;
    }

    const col = document.createElement('div');
    col.className = 'bar-col';
    col.innerHTML = `
      <div class="bar-fill-container">
        <div class="bar-fill${isToday ? ' today-bar' : ''}" style="height:${pct}%">
          ${val > 0 ? `<div class="bar-fill-num">${val}</div>` : ''}
        </div>
      </div>
      <div class="bar-label">${lbl}</div>
    `;
    chart.appendChild(col);
  });
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   RENDER: MILESTONES
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

function renderMilestones() {
  const list = document.getElementById('milestone-list');
  list.innerHTML = '';
  const total = userData.totalQuestions || 0;

  for (const ms of MILESTONES) {
    const progress  = Math.min(total, ms.target);
    const pct       = (progress / ms.target) * 100;
    const completed = total >= ms.target;

    const item = document.createElement('div');
    item.className = 'milestone-item' + (completed ? ' completed' : '');
    item.innerHTML = `
      <div class="milestone-icon">${completed ? '‚úÖ' : 'üéØ'}</div>
      <div class="milestone-content">
        <div class="milestone-title">${ms.label}</div>
        <div class="milestone-progress-bar-outer">
          <div class="milestone-progress-bar-fill" style="width:${pct}%"></div>
        </div>
      </div>
      <div class="milestone-fraction">${progress} / ${ms.target}</div>
    `;
    list.appendChild(item);
  }
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   RENDER: ACHIEVEMENTS
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

function renderAchievements() {
  const grid  = document.getElementById('achievements-grid');
  grid.innerHTML = '';
  const today    = getDateKey();
  const weekKey  = getWeekKey();

  const statMap = {
    total:  userData.totalQuestions || 0,
    today:  userData.dailyCounts[today] || 0,
    streak: userData.streak || 0,
    level:  getLevelInfo(userData.totalXP || 0).level,
    week:   userData.weeklyCounts[weekKey] || 0,
    tasks:  userData.completedTasks || 0,
    items:  (userData.inventory || []).length + EQUIPMENT_SLOTS.filter((slot) => !!userData.equipment[slot]).length,
    wins:   (userData.miniGame && userData.miniGame.wins) || 0,
  };

  for (const ach of ACHIEVEMENTS_DEF) {
    const unlocked = !!userData.achievements[ach.id];
    const val      = statMap[ach.stat] || 0;
    const progress = unlocked ? ach.threshold : val;

    const card = document.createElement('div');
    card.className = 'achievement-card' + (unlocked ? ' unlocked' : '');
    card.innerHTML = `
      <div class="achievement-icon">${ach.icon}</div>
      <div class="achievement-info">
        <div class="achievement-name">${ach.name}</div>
        <div class="achievement-desc">${ach.desc}</div>
        <div class="achievement-status">${unlocked ? '‚úì UNLOCKED' : `${progress} / ${ach.threshold}`}</div>
      </div>
    `;
    grid.appendChild(card);
  }
}

function renderTodoList() {
  const todoList = document.getElementById('todo-list');
  if (!todoList) return;
  const tasks = userData.todoTasks || [];
  if (!tasks.length) {
    todoList.innerHTML = '<div class="log-empty">No tasks yet ‚Äî add a task to begin your todo quest.</div>';
    return;
  }

  todoList.innerHTML = '';
  for (const task of tasks) {
    const row = document.createElement('div');
    row.className = 'todo-row';
    row.innerHTML = `
      <div class="todo-title ${task.completed ? 'done' : ''}">${escapeHtml(task.title)}</div>
      <span class="tag ${task.importance >= 9 ? 'high' : ''}">Imp ${task.importance}</span>
      ${task.completed
        ? '<span class="tag">Done</span>'
        : `<button class="quest-btn" onclick="completeTask('${task.id}')">Complete</button>`}
    `;
    todoList.appendChild(row);
  }
}

function renderRpgPanel() {
  const slotGrid = document.getElementById('slot-grid');
  const skillsRow = document.getElementById('skills-row');
  const inventoryList = document.getElementById('inventory-list');
  if (!slotGrid || !skillsRow || !inventoryList) return;

  const prettySlot = {
    helm: 'Helm', chest: 'Chest', gloves: 'Gloves', pants: 'Pants', boots: 'Boots',
    weapon: 'Weapon', offhand: 'Offhand', ring1: 'Ring 1', ring2: 'Ring 2', amulet: 'Amulet',
  };

  slotGrid.innerHTML = '';
  for (const slot of EQUIPMENT_SLOTS) {
    const item = userData.equipment[slot];
    const el = document.createElement('div');
    el.className = 'slot-card';
    el.innerHTML = `
      <div class="slot-name">${prettySlot[slot]}</div>
      ${item
        ? `<div class="slot-item">${item.name}<br/>ATK +${item.atk} ¬∑ DEF +${item.def}</div>
           <button class="quest-btn" style="margin-top:6px;padding:6px 8px;font-size:11px;" onclick="unequipSlot('${slot}')">Unequip</button>`
        : '<div class="slot-empty">Empty slot</div>'}
    `;
    slotGrid.appendChild(el);
  }

  skillsRow.innerHTML = '';
  for (const skill of userData.skills || []) {
    const pill = document.createElement('span');
    pill.className = 'skill-pill';
    pill.textContent = `${skill.name} x${Number(skill.power || 1).toFixed(2)}`;
    skillsRow.appendChild(pill);
  }

  inventoryList.innerHTML = '';
  if (!(userData.inventory || []).length) {
    inventoryList.innerHTML = '<div class="slot-empty">No items yet. Complete tasks or win battles for drops.</div>';
    return;
  }

  for (const item of userData.inventory) {
    const row = document.createElement('div');
    row.className = 'inventory-row';
    row.innerHTML = `
      <div>${item.name} ¬∑ ${item.slot}<br/><span class="slot-empty">${item.rarity} ¬∑ ATK +${item.atk} ¬∑ DEF +${item.def}</span></div>
      <button class="quest-btn" style="padding:6px 8px;font-size:11px;" onclick="equipItem('${item.id}')">Equip</button>
    `;
    inventoryList.appendChild(row);
  }
}

function renderMiniGame() {
  const battleStats = document.getElementById('battle-stats');
  const battleLog = document.getElementById('battle-log');
  if (!battleStats || !battleLog) return;
  const stats = getCharacterStats();
  const game = userData.miniGame;
  battleStats.innerHTML = `
    <div class="battle-stat">HP<br/><strong>${game.inBattle ? game.playerHp : stats.maxHp}</strong></div>
    <div class="battle-stat">ATK<br/><strong>${stats.atk}</strong></div>
    <div class="battle-stat">DEF<br/><strong>${stats.def}</strong></div>
    <div class="battle-stat">Wins / Plays<br/><strong>${game.wins} / ${game.plays}</strong></div>
  `;

  if (game.inBattle) {
    battleLog.textContent = `${game.enemyName} HP ${game.enemyHp}/${game.enemyMaxHp} ¬∑ ${game.log}`;
  } else {
    battleLog.textContent = game.log || 'No battle yet. Start one to enter the arena.';
  }
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   RENDER: ACTIVITY LOG
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

function renderLog() {
  const logEl = document.getElementById('activity-log');
  const logs  = userData.recentLog || [];

  if (logs.length === 0) {
    logEl.innerHTML = '<div class="log-empty">No activity yet ‚Äî press + to begin your quest!</div>';
    return;
  }

  logEl.innerHTML = '';
  for (const entry of logs) {
    const row = document.createElement('div');
    row.className = 'log-entry';
    const d = new Date(entry.ts);
    const timeStr = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    const dateStr = `${d.getDate()}/${d.getMonth()+1}`;
    row.innerHTML = `
      <div class="log-dot"></div>
      <div class="log-text">
        <strong>${escapeHtml(entry.text)}</strong>
        &nbsp;¬∑&nbsp;
        <span class="xp-highlight">+${entry.xp} XP</span>
      </div>
      <div class="log-time">${dateStr} ${timeStr}</div>
    `;
    logEl.appendChild(row);
  }
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   AUTH STATE OBSERVER
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

auth.onAuthStateChanged(async (user) => {
  if (user) {
    currentUser = user;
    showScreen('loading');

    try {
      userData = await loadUserData(user.uid);
      ensureRpgDefaults(userData);
    } catch (e) {
      console.error("Failed to load data:", e);
      userData = {
        totalXP: 0, totalQuestions: 0, streak: 0,
        lastActiveDate: null, longestStreak: 0,
        dailyCounts: {}, weeklyCounts: {}, monthlyCounts: {}, yearlyCounts: {},
        achievements: {}, recentLog: [],
        todoTasks: [], completedTasks: 0, inventory: [],
        equipment: getBaseEquipment(), skills: rollSkills(3),
        miniGame: { wins: 0, plays: 0, inBattle: false, playerHp: 100, enemyHp: 0, enemyMaxHp: 0, enemyPower: 0, enemyName: '', log: 'No battle yet. Start one to enter the arena.' },
      };
    }

    // Set user display
    const nameEl   = document.getElementById('user-name-el');
    const avatarEl = document.getElementById('user-avatar-el');
    if (user.displayName) nameEl.textContent = user.displayName.split(' ')[0];
    if (user.photoURL) {
      avatarEl.innerHTML = `<img class="user-avatar" src="${user.photoURL}" alt="avatar" />`;
    }

    renderAll();
    startUserDataSync(user.uid);
    showScreen('main');
  } else {
    if (userDocUnsubscribe) {
      userDocUnsubscribe();
      userDocUnsubscribe = null;
    }
    showScreen('login');
  }
});

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   WINDOW RESIZE ‚Äî CONFETTI CANVAS
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
window.addEventListener('resize', () => {
  const canvas = document.getElementById('confetti-canvas');
  canvas.width  = window.innerWidth;
  canvas.height = window.innerHeight;
});
</script>

</body>
</html>
